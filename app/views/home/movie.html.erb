<div id="tooltip" class="hidden">
        <p><strong>コメント数 : </strong><span id="value">100</span></p>
        <p><strong>再生位置 : </strong><span id="value2">100</span></p>
</div>
<style type="text/css">
#tooltip {
        position: absolute;
        z-index: 10;
        width: 150px;
        height: auto;
        padding: 10px;
        background-color: white;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
        opacity: 0.93;
}

#tooltip.hidden {
        display: none;
}

#tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
}

.axis path,
.axis line{
    fill: none;
    stroke: black;
}

.tick line{
    opacity: 0.2;
}

</style>
<script>
$(function() {
    $('#movie-tabs a').click(function (e) {
      e.preventDefault();
      $(this).tab('show');
    });

    $(document).on('click', '#btnCreate', function(e) {
        e.preventDefault();
        try {
            $('#vpos').val(function() {
                var player = document.getElementById('external_nico_0');
                return player.ext_getPlayheadTime() * 100;
                });
            $('#create-fusen').submit();
        } catch (e) {
            alert("再生ボタンを押してください。");
        }
    });

    $(document).on('click', '#btnGraph', function(e) {
        e.preventDefault();
        $('#graph-reload').submit();
    });

    $(document).on('keydown', '#create-fusen', function(e) {
        if((e.which && e.which === 13) || (e.keyCode && e.keyCode === 13)) {
            e.preventDefault();
            try {
                $('#vpos').val(function() {
                    var player = document.getElementById('external_nico_0');
                    return player.ext_getPlayheadTime() * 100;
                    });
                $('#create-fusen').submit();
            } catch (e) {
                alert("再生ボタンを押してください。");
            }
        } else {
            return true;
        }
    });

    $(document).on('click', 'a.bookmark' ,function(e) {
        e.preventDefault();
        var player = document.getElementById('external_nico_0');
        try {
        player.ext_setPlayheadTime($(this).data('vpos') / 100);
        } catch (e) {
        alert("再生ボタンを押してください。");
        }
    });

    var args = $.getParameter();
    if (args['fusen'] !== undefined) {
        var target = '#' + args['fusen'];
        $(target).addClass('success');
        $(target).prependTo('#bookmark tbody');
    }

    createDataTable("#bookmark", 8, [null, null, null, {"orderable": false}]);
});

$(document).ready(function(){
        $("#div_num").validationEngine('attach', {promptPosition : "bottomLeft", scroll: false});
});
</script>


<div class="container mt">
    <div class="row centered">
        <%= form_tag(controller: "home", action: "search", method: "post") do %>
            <div class="col-lg-7 col-lg-offset-1">
            <%= text_field_tag(:q, @q, class: "form-control input-lg", placeholder: "sm* または keyword") %>
        </div>
        <div class="col-lg-3">
            <%= submit_tag("再生", class: "bolt-btn btn-theme btn-lg") %>
        </div>
    <%end%>
    </div>
    <hr>
    <div class="row centered">
        <div class="row centered">
            <H2><%=@video_title%></H2>
        </div>
        <div class="row centered">
            <div class="col-lg-6 centered mt" data-step="1" data-intro="ここが動画再生エリアです。">
                <script type="text/javascript" src=<%= "http://ext.nicovideo.jp/thumb_watch/"+@id %>></script><noscript><a href= <%="http://www.nicovideo.jp/watch/"+ @id %>>nicovideo</a></noscript>

                <% if user_signed_in? %>
                    <div class="row centered mt">
                    <%= form_tag({:controller => 'home', :action => 'create'}, :remote => true, :class => 'form-ajax', :id => 'create-fusen') do %>
                        <%= hidden_field_tag :smid, @id %>
                    <%= hidden_field_tag :start_vpos, 0, :id => 'vpos' %>
                    <div class="input-group" data-step="2" data-intro="動画のおすすめな部分にコメントをつけて保存することができます。">
                        <%= text_field_tag :comment, "", :class => "form-control", placeholder: "ふせんにコメントをつけてみる" %>
                        <span class="input-group-btn">
                            <%= link_to '<i class="glyphicon glyphicon-bookmark"></i>ふせんをつける'.html_safe, '#', :class => 'btn btn--s btn-no-padding', :id => 'btnCreate' %>
                        </span>
                        </div>
                    <% end %>
                    </div>
                <% end %>
            </div>

            <div class="col-lg-6">
                <ul id="movie-tabs" class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#graph-tab" aria-controls="graph-tab" role="tab" data-toggle="tab" data-step="3" data-intro="盛り上がりグラフを表示します。動画を読み込んでから棒グラフをクリックすると、その位置を再生します。">コメントグラフ</a>
                    </li>
                    <li role="presentation">
                        <a href="#fusen-tab" aria-controls="fusen-tab" role="tab" data-toggle="tab" data-step="4" data-intro="この動画につけられたふせんを表示します。ふせん一覧からおすすめのふせんをFacebookやTwitterで共有することができます。">ふせん</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div id="graph-tab" class="tab-pane active">
                        <div id="chart"></div>
                        <script>
var svgWidth = 520; // SVG領域の横幅
var svgHeight = 360;    // SVG領域の縦幅
var margin = {top: 20, right: 40, bottom: 40, left: 50};
var chart_width = svgWidth - margin.left - margin.right;
var chart_height = svgHeight - margin.top - margin.bottom;
var ymax_position = 1.25  //

var time_watch = [
<% @time_watch.each do |time| %>
    <%= time %>,
<% end %>
]; // vposによるブロック毎の動画開始位置

var block_com_num = [
<% @block_com_num.each do |com_num| %>
    <%= com_num %>,
<% end %>
]; // ブロック毎のコメント数

var movie_start_time = [
<% @start_time.each do |time| %>
    "<%= time %>",
<% end %>
]; // ブロック毎の動画開始位置

var comment_max = Math.max.apply(null, block_com_num); // コメントの最大値
var color3 = "#ff7f0e"
var colors2 = d3.scale.linear()
    .domain([0,comment_max])
    .range(["skyblue", "darkblue"]);

        var line = d3.svg.line()
            .x(function(d, i) { return i * svgWidth;})
            .y(function(d) { return chart_height - d * yScale; });

        var yScale = (function (height, num_max, rate) {
                    if (num_max !== 0) {
                    magnification = height/num_max/rate;
                    return magnification;
                    } else {
                    return 0;
                    }
                    }(chart_height, comment_max, ymax_position)); // グラフの高さの倍率
        var tooltip = d3.select("#tooltip")

        var svg = d3.select("#chart").append("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.selectAll("rect")   // 四角形を対象にする
    .data(block_com_num)  // データを読み込む
.enter()
    .append("rect") // 四角形を生成する
    .attr("x", function(d, i){  // X座標を計算
            return i * chart_width / <%= @m_division %> ;
            })
.attr("y", function(d){ // Y座標を計算
        return chart_height - d * yScale;
        })
.attr("width", 0)  // 四角形の横幅
.attr("height", function(d){ // 四角形の高さ
        return d * yScale;})
.attr("fill", function(d,i){    // 色を指定する
        return colors2(d);    // 色を返す
        })
.on("mouseover", function(d,i){
        d3.select(this).attr("fill","red");
        tooltip.select("#value")
        .text(d);
        tooltip.select("#value2")
        .text(movie_start_time[i]);
        d3.select("#tooltip").classed("hidden",false);
       })
.on("mousemove", function(d){
        return tooltip.style("top", (d3.event.pageY-20)+"px").style("left",(d3.event.pageX+10)+"px"); //ポップアップが表示される位置の指定
        })

.on("mouseout", function(d,i){
        d3.select(this).attr("fill",colors2(d));
        d3.select("#tooltip").classed("hidden",true);
        })
.on("click", function(d,i){
        var player = document.getElementById('external_nico_0');
        try {
        player.ext_setPlayheadTime(time_watch[i]);
        } catch (e) {
        alert("再生ボタンを押してください。");
        }

        })
.transition() //アニメーション
    .delay(function(d, i){　
            //それぞれの棒を遅くれて表示
            return i * 1000 / <%= @m_division %>;
            })
.duration(1000)
    .ease("bounce")
    .attr("width", chart_width / <%= @m_division %>) //四角形の横幅
    .attr("height", function(d){ // 四角形の高さ
            return d * yScale;
            })

    var xAxis = d3.svg.axis()
.scale(d3.scale.linear().domain([0, <%= @vpos_video_length/100 %>*0.9]).range([0, chart_width*0.9]))
    .orient("bottom")
//    .tickSize(6, -chart_height)
    .ticks(5)
    .innerTickSize(-chart_height)  // 目盛線の長さ（内側）
    .outerTickSize(0) // 目盛線の長さ（外側）
    .tickPadding(10) // 目盛線とテキストの間の長さ
    .tickFormat(function(d) { 
            var value = "";
            var second = d % 60;
            var minute = (d - second) / 60;
            if (minute > 0) {
            value += minute + "分";
            }
            return value + second + "秒"; 
            });
    var yAxis = d3.svg.axis()
    .ticks(5)
.scale(d3.scale.linear().domain([0, comment_max*ymax_position]).range([chart_height, 0]))
    .orient("left")
   // .tickSize(6, -chart_width);
    .innerTickSize(-chart_width)
    .outerTickSize(0)
    .tickPadding(10);

    var xSVG = svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0, " + chart_height + ")")
    .call(xAxis);
    xSVG.append("text")
    .attr("y", 35)
    .attr("x", 200)
    .style("text-anchor", "middle")
    .text("経過時間 / 分秒");
    var Lsecond = <%= @vpos_video_length/100 % 60 %>;
    var Lminute = (<%= @vpos_video_length/100 %> - Lsecond) / 60;
    if (Lminute > 0) {
        Lminute += "分";
    } else Lminute = "分";
xSVG.append("text")
.attr("y", 17)
.attr("x", 450)
.style("text-anchor", "end")
.text(Lminute + Lsecond + "秒");

svg.append("g")
            .attr("class", "y axis")
        .call(yAxis)
            .append("text")
            .attr("y", -10)
            .style("text-anchor", "end")
            .text("コメント数");

            svg.append("path")
            .attr("d", line([<%= @threshold %>, <%= @threshold %>]))
            .attr("stroke", "#ff7f0e")
            .attr("stroke-width", 3)
            .attr("stroke-dasharray", "5, 2")
            .attr("fill", "none");
                        </script>
<!-- フォーム -->
<form id="div_num" action="" method="get" name="division" class="form-inline">
    <div class="form-group">
        <label class="control-label" for="number"> 分割数 :
            <input style="width:75px;" type="text" value="<%= @m_division %>" name='num' maxlength="5" class="validate[required,custom[integer],min[1],max[<%= @vpos_video_length/100 %>]]"
                      data-errormessage-value-missing="入力されていません"
                      data-errormessage="整数値を入力してください"
                      data-errormessage-range-underflow="最小値は1です"
                      data-errormessage-range-overflow="最大値は<%= @vpos_video_length/100 %>です" >
    </div>
           <!--   <button type="submit" class="btn btn-sm">送信</button> -->
    <button id="button" class="btn btn--m btn--blue" type="submit" style="position:relative; left:2px; top:4px; padding-top: 3px; padding-bottom: 3px; padding-left: 8px; padding-right: 8px"> 変更</button>
        </label>
            </form>
                    </div>

                    <div id="fusen-tab" role="tabpanel" class="tab-pane">
                        <table id="bookmark" class="table table-hover table-striped table-bordered dataTable" role="grid">
                            <thead>
                                <tr>
                                    <th>再生位置</th>
                                    <th>コメント</th>
                                    <th>ユーザー</th>
                                    <th>共有</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%= render partial: 'home/bookmark', locals: { bookmarks: @bookmarks } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <% if Rails.env.development? %>
        <b>分割数 : </b>
        <%= @m_division %>
        <br>


        <b>閾値 : </b>
        <%= @threshold %>
        <br>

        <b>ブロックごとのコメント数 :</b>
        <% @block_com_num.each do |com_num| %>
            <%= com_num %>
        <% end %>

        <br>
        <b>ブロックごとの動画開始位置 :</b>
        <% @start_time.each do |time| %>
            <%= time %>
        <% end %>

        <br>
        <b>ハイライト該当箇所 :</b>
        <% @highlights_place.each do |start, finish| %>
            <%= start.to_s + '~' + finish.to_s %>
        <% end %>

        <br>
    <% end %>
</div>
